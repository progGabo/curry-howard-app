<app-header
  [headerOption]="headerOption"
  [mode]="mode"
  [interactiveSubmode]="interactiveSubmode"
  [isPredicateLogic]="isPredicateLogic"
  [canStepBack]="canStepBack"
  [currentLanguage]="currentLanguage"
  [t]="t"
  (headerOptionChange)="onHeaderOptionChange($event)"
  (modeChange)="onHeaderModeChange($event)"
  (submodeChange)="interactiveSubmode = $event"
  (stepBack)="stepBack()"
  (helpClick)="helpVisible = true"
  (languageChange)="currentLanguage = $event"
></app-header>

<!-- Slide Panel Toggle Button -->
<button
  class="slide-panel-toggle"
  (click)="slidePanelVisible = !slidePanelVisible"
  [class.active]="slidePanelVisible"
  [attr.aria-label]="slidePanelVisible ? (currentLanguage === 'sk' ? 'Skryť panel pravidiel' : 'Hide rules panel') : (currentLanguage === 'sk' ? 'Zobraziť panel pravidiel' : 'Show rules panel')"
  [attr.aria-expanded]="slidePanelVisible"
  aria-controls="rules-slide-panel"
>
  <i [class]="slidePanelVisible ? 'pi pi-chevron-right' : 'pi pi-chevron-left'"></i>
</button>

<!-- Slide Panel -->
<div id="rules-slide-panel" class="slide-panel" [class.open]="slidePanelVisible" [attr.aria-hidden]="!slidePanelVisible">
  <div class="slide-panel-content">
    <div class="rule-formula-panel">
      <h3 class="formula-title">{{ t.ruleReference }}</h3>
      
      <!-- All Rules Formulas Display -->
      <div class="formulas-list">
        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.seqIdentityCut }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarIdentityCutRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.seqLogicalNegation }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarNegationRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.conjunction }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarConjunctionRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.disjunction }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarDisjunctionRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.implication }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarImplicationRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.quantifiers }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarQuantifierRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isSequentWorkflow">
          <h4 class="formula-section-header">{{ t.seqWeakening }}</h4>
          <div class="formula-item" *ngFor="let rule of seqSidebarWeakeningRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.constants }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarCoreRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.negation }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarNegationRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.conjunction }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarConjunctionRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.disjunction }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarDisjunctionRules">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.implication }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarImplicationRules" [class.formula-item--imp-e]="rule === '→E'">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isNaturalDeductionWorkflow">
          <h4 class="formula-section-header">{{ t.quantifiers }}</h4>
          <div class="formula-item" *ngFor="let rule of ndSidebarQuantifierRules" [class.formula-item--full-row]="rule === '∃E'">
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.basicRules }}</h4>
          <div class="formula-item" *ngFor="let rule of basicRules">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.functions }}</h4>
          <div class="formula-item" *ngFor="let rule of absRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
          <div class="formula-item" *ngFor="let rule of appRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.pairsAndSums }}</h4>
          <div class="formula-item" *ngFor="let rule of pairRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
          <div class="formula-item" *ngFor="let rule of sumRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.dependentTypes }}</h4>
          <div class="formula-item" *ngFor="let rule of dependentRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.controlFlow }}</h4>
          <div class="formula-item" *ngFor="let rule of conditionalRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
          <div class="formula-item" *ngFor="let rule of letRules" [class.formula-item--full-row]="isTypeInferenceSidebarFullRow(rule)">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>

        <div class="formula-section" *ngIf="isLambdaToExpressionWorkflow">
          <h4 class="formula-section-header">{{ t.naturals }}</h4>
          <div class="formula-item" *ngFor="let rule of natRules">
            <div class="formula-item-header">{{ rule }}</div>
            <div class="formula-item-box" [appKatex]="getRuleFormula(rule)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="main">
  <p-splitter [style]="{ height: '100%' }" [panelSizes]="panelSizes" [minSizes]="[15, 0]" layout="horizontal" styleClass="main-splitter" (onResizeEnd)="onSplitterResizeEnd($event)">
    <ng-template pTemplate>
      <div class="editor-panel">
        <div class="examples">
          <label class="examples-label">{{ t.examples }}</label>
          <div class="examples-row">
            <select class="select examples-select" (change)="applyExample($any($event.target).value)">
              <option value="" selected disabled>{{ examplesPlaceholder }}</option>
              <option *ngFor="let ex of currentExamples" [value]="ex.code">{{ ex.label }}</option>
            </select>
            <p-button (click)="parseAndBuild()" styleClass="btn btn-primary examples-btn">
              {{ isLambdaToExpressionWorkflow ? t.convertLambda : t.generateProof }}
            </p-button>
          </div>
        </div>
        <div class="editor-wrapper">
          <div class="editor">
            <app-editor 
              [conversionMode]="conversionMode"
              [presetCode]="code"
              (formulaEntered)="onInputChanged($event)">
            </app-editor>
          </div>
          <app-proof-lambda
            *ngIf="shouldGenerateLambdaFromProof && lambdaExpr"
            [lambdaExpr]="lambdaExpr"
            [label]="t.lambdaExpression"
          ></app-proof-lambda>
          <div class="result-type" *ngIf="isLambdaToExpressionWorkflow && resultExpression">
            <h4>{{ t.exprType }}</h4>
            <pre>{{ resultExpression }}</pre>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate>
      <div class="proof-container">
        <div class="tree-panel" *ngIf="proofTree || naturalDeductionTree || resultExpression || typeInferenceTree">
          
          <div *ngIf="isSequentWorkflow">
            <app-tree-canvas [resetTrigger]="treeCanvasResetTrigger" [initialZoom]="0.85">
              <app-proof-tree
                [root]="proofTree"
                [mode]="mode"
                [interactiveSubmode]="interactiveSubmode"
                [currentLanguage]="currentLanguage"
                [selectedNode]="selectedNode"
                [predictionRuleRequest]="predictionRuleRequest"
                (nodeClicked)="onNodeClicked($event)"
                (plusButtonClicked)="onProofPlusButtonClicked($event)"
                (ruleSelected)="applyRuleToNode($event)"
              ></app-proof-tree>
            </app-tree-canvas>
          </div>

          <div *ngIf="isNaturalDeductionWorkflow">
            <app-tree-canvas [resetTrigger]="treeCanvasResetTrigger" [initialZoom]="0.85">
              <div canvas-overlay class="nd-hypotheses-floating" *ngIf="ndHypotheses.length">
                <span class="title">{{ t.hypotheses }}</span>
                <div class="hyp-row" *ngFor="let hypothesis of ndHypotheses" [class.hyp-row--closed]="hypothesis.isClosed" [class.hyp-row--open]="!hypothesis.isClosed">
                  <span class="label">{{ hypothesis.label }} =</span>
                  <span class="expr" [appKatex]="hypothesis.formulaLatex"></span>
                </div>
              </div>
              <app-natural-deduction-tree
                [root]="naturalDeductionTree"
                [mode]="mode"
                [selectedNode]="selectedNdNode"
                [ndPredictionRequest]="ndPredictionRequest"
                [currentLanguage]="currentLanguage"
                (nodeClicked)="onNdNodeClicked($event)"
                (plusButtonClicked)="onNdPlusButtonClicked($event)"
                (ndPredictionConfirm)="confirmNdPrediction($event)"
                (ndPredictionCancel)="cancelNdPrediction()"
              ></app-natural-deduction-tree>
            </app-tree-canvas>
          </div>
          
          <div *ngIf="isLambdaToExpressionWorkflow">
            <app-tree-canvas [resetTrigger]="treeCanvasResetTrigger">
              <div class="type-inference-section">
                <app-type-inference-tree
                  [root]="typeInferenceTree"
                  [mode]="mode"
                  [interactiveSubmode]="interactiveSubmode"
                  [selectedNode]="selectedTypeNode"
                  [predictionRuleRequest]="predictionTypeRuleRequest"
                  [currentLanguage]="currentLanguage"
                  (nodeClicked)="onTypeNodeClicked($event)"
                  (plusButtonClicked)="onTypePlusButtonClicked($event)"
                  (ruleSelected)="applyTypeRuleToNode($event)"
                ></app-type-inference-tree>
              </div>
            </app-tree-canvas>
          </div>
          
        </div>
      </div>
    </ng-template>
  </p-splitter>
</div>

<p-toast></p-toast>

<app-rule-menu-popup
  [visible]="popupVisible"
  [popupX]="popupX"
  [popupY]="popupY"
  [conversionMode]="conversionMode"
  [t]="t"
  [filteredConclusionRules]="filteredConclusionRules"
  [filteredAssumptionRules]="filteredAssumptionRules"
  [filteredSpecialRules]="filteredSpecialRules"
  [filteredBasicRules]="filteredBasicRules"
  [filteredAbsRules]="filteredAbsRules"
  [filteredAppRules]="filteredAppRules"
  [filteredPairRules]="filteredPairRules"
  [filteredDependentRules]="filteredDependentRules"
  [filteredSumRules]="filteredSumRules"
  [filteredConditionalRules]="filteredConditionalRules"
  [filteredNatRules]="filteredNatRules"
  [filteredLetRules]="filteredLetRules"
  [filteredNdIntroRules]="filteredNdIntroRules"
  [filteredNdElimRules]="filteredNdElimRules"
  [filteredNdQuantifierRules]="filteredNdQuantifierRules"
  (proofRuleClick)="onProofRuleClick($event)"
  (typeRuleClick)="onTypeRuleClick($event)"
  (close)="closePopup()"
  (positionChange)="onPopupPositionChange($event)"
></app-rule-menu-popup>

<app-help-modal
  [visible]="helpVisible"
  [currentLanguage]="currentLanguage"
  [t]="t"
  (close)="helpVisible = false"
></app-help-modal>

<footer class="footer">
  <div class="footer-inner">
    <span>© {{ currentYear }} {{ t.footerText }}</span>
  </div>
</footer>