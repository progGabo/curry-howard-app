<app-header
  [conversionMode]="conversionMode"
  [mode]="mode"
  [interactiveSubmode]="interactiveSubmode"
  [isPredicateLogic]="isPredicateLogic"
  [canStepBack]="canStepBack"
  [currentLanguage]="currentLanguage"
  [t]="t"
  (conversionModeChange)="switchMode($event)"
  (modeChange)="onHeaderModeChange($event)"
  (submodeChange)="interactiveSubmode = $event"
  (stepBack)="stepBack()"
  (helpClick)="helpVisible = true"
  (languageChange)="currentLanguage = $event"
></app-header>

<!-- Slide Panel Toggle Button -->
<button class="slide-panel-toggle" (click)="slidePanelVisible = !slidePanelVisible" [class.active]="slidePanelVisible">
  <i [class]="slidePanelVisible ? 'pi pi-chevron-right' : 'pi pi-chevron-left'"></i>
</button>

<!-- Slide Panel -->
<div class="slide-panel" [class.open]="slidePanelVisible">
  <div class="slide-panel-content">
    <!-- Content will go here -->
  </div>
</div>

<div class="main">
  <p-splitter [style]="{ height: '100%' }" [panelSizes]="panelSizes" [minSizes]="[15, 0]" layout="horizontal" styleClass="main-splitter" (onResizeEnd)="onSplitterResizeEnd($event)">
    <ng-template pTemplate>
      <div class="editor-panel">
        <div class="examples">
          <label class="examples-label">{{ t.examples }}</label>
          <div class="examples-row">
            <select *ngIf="conversionMode === 'expression-to-lambda'" class="select examples-select" (change)="applyExample($any($event.target).value)">
              <option value="" selected disabled>{{ t.chooseExampleExpr }}</option>
              <option *ngFor="let ex of expressionExamples" [value]="ex.code">{{ ex.label }}</option>
            </select>
            <select *ngIf="conversionMode === 'lambda-to-expression'" class="select examples-select" (change)="applyExample($any($event.target).value)">
              <option value="" selected disabled>{{ t.chooseExampleLambda }}</option>
              <option *ngFor="let ex of lambdaExamples" [value]="ex.code">{{ ex.label }}</option>
            </select>
            <p-button (click)="parseAndBuild()" styleClass="btn btn-primary examples-btn">
              {{ conversionMode === 'expression-to-lambda' ? t.generateProof : t.convertLambda }}
            </p-button>
          </div>
        </div>
        <div class="editor-wrapper">
          <div class="editor">
            <app-editor 
              [conversionMode]="conversionMode"
              [presetCode]="code"
              (formulaEntered)="onInputChanged($event)">
            </app-editor>
          </div>
          <app-proof-lambda
            *ngIf="conversionMode === 'expression-to-lambda' && lambdaExpr"
            [lambdaExpr]="lambdaExpr"
            [label]="t.lambdaExpression"
          ></app-proof-lambda>
          <div class="result-type" *ngIf="conversionMode === 'lambda-to-expression' && resultExpression">
            <h4>{{ t.exprType }}</h4>
            <pre>{{ resultExpression }}</pre>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate>
      <div class="proof-container">
        <div class="tree-panel" *ngIf="proofTree || resultExpression || typeInferenceTree">
          
          <div *ngIf="conversionMode === 'expression-to-lambda'">
            <div class="tabs-container">
              <div class="tabs-header">
                <button 
                  class="tab-button" 
                  [class.active]="activeTab === 'proof'"
                  (click)="activeTab = 'proof'"
                >
                  {{ t.proofTree }}
                </button>
                <button 
                  *ngIf="lambdaExprNode"
                  class="tab-button" 
                  [class.active]="activeTab === 'typeInference'"
                  (click)="activeTab = 'typeInference'"
                >
                  {{ currentLanguage === 'sk' ? 'Strom odvodenia typu' : 'Type Inference Tree' }}
                </button>
              </div>
              <div class="tabs-content">
                <div *ngIf="activeTab === 'proof'" class="tab-panel">
                  <app-tree-canvas [resetTrigger]="treeCanvasResetTrigger">
                    <app-proof-tree
                      [root]="proofTree"
                      [mode]="mode"
                      [interactiveSubmode]="interactiveSubmode"
                      [currentLanguage]="currentLanguage"
                      [selectedNode]="selectedNode"
                      [predictionRuleRequest]="predictionRuleRequest"
                      (nodeClicked)="onNodeClicked($event)"
                      (plusButtonClicked)="onProofPlusButtonClicked($event)"
                      (ruleSelected)="applyRuleToNode($event)"
                    ></app-proof-tree>
                  </app-tree-canvas>
                </div>
                <div *ngIf="activeTab === 'typeInference' && lambdaExprNode" class="tab-panel">
                  <div *ngIf="!typeInferenceTreeForLambda" class="type-inference-error">
                    {{ currentLanguage === 'sk' ? 'Strom typu sa nepodarilo zostaviť (napr. chýbajúce typy predpokladov).' : 'Type inference tree could not be built (e.g. missing assumption types).' }}
                  </div>
                  <app-tree-canvas *ngIf="typeInferenceTreeForLambda" [resetTrigger]="treeCanvasResetTrigger">
                    <app-type-inference-tree
                      [root]="typeInferenceTreeForLambda"
                      [mode]="'auto'"
                      [interactiveSubmode]="'all'"
                      [selectedNode]="null"
                      [currentLanguage]="currentLanguage"
                    ></app-type-inference-tree>
                  </app-tree-canvas>
                </div>
              </div>
            </div>
          </div>
          
          <div *ngIf="conversionMode === 'lambda-to-expression'">
            <app-tree-canvas [resetTrigger]="treeCanvasResetTrigger">
              <div class="type-inference-section">
                <app-type-inference-tree
                  [root]="typeInferenceTree"
                  [mode]="mode"
                  [interactiveSubmode]="interactiveSubmode"
                  [selectedNode]="selectedTypeNode"
                  [predictionRuleRequest]="predictionTypeRuleRequest"
                  [currentLanguage]="currentLanguage"
                  (nodeClicked)="onTypeNodeClicked($event)"
                  (plusButtonClicked)="onTypePlusButtonClicked($event)"
                  (ruleSelected)="applyTypeRuleToNode($event)"
                ></app-type-inference-tree>
              </div>
            </app-tree-canvas>
          </div>
          
        </div>
      </div>
    </ng-template>
  </p-splitter>
</div>

<p-toast></p-toast>

<app-rule-menu-popup
  [visible]="popupVisible"
  [popupX]="popupX"
  [popupY]="popupY"
  [conversionMode]="conversionMode"
  [filteredConclusionRules]="filteredConclusionRules"
  [filteredAssumptionRules]="filteredAssumptionRules"
  [filteredSpecialRules]="filteredSpecialRules"
  [filteredBasicRules]="filteredBasicRules"
  [filteredAbsRules]="filteredAbsRules"
  [filteredAppRules]="filteredAppRules"
  [filteredPairRules]="filteredPairRules"
  [filteredDependentRules]="filteredDependentRules"
  [filteredSumRules]="filteredSumRules"
  [filteredConditionalRules]="filteredConditionalRules"
  [filteredNatRules]="filteredNatRules"
  [filteredLetRules]="filteredLetRules"
  (proofRuleClick)="onProofRuleClick($event)"
  (typeRuleClick)="onTypeRuleClick($event)"
  (close)="closePopup()"
  (positionChange)="onPopupPositionChange($event)"
></app-rule-menu-popup>

<app-help-modal
  [visible]="helpVisible"
  [currentLanguage]="currentLanguage"
  [t]="t"
  (close)="helpVisible = false"
></app-help-modal>

<footer class="footer">
  <div class="footer-inner">
    <span>© {{ currentYear }} {{ t.footerText }}</span>
  </div>
</footer>