<div class="rule-menu-wrapper" *ngIf="visible">
  <div class="backdrop" (click)="onClose()"></div>
  <div
    class="rule-menu-popup"
    [ngStyle]="popupPosition"
    role="dialog"
    aria-modal="true"
    [attr.aria-label]="t.addRule"
    (mousemove)="onDragMove($event)"
    (mouseup)="onDragEnd()"
    (mouseleave)="onDragEnd()"
  >
  <div class="popup-content">
    <!-- Expression to Lambda Mode -->
    <div *ngIf="conversionMode === 'expression-to-lambda'" class="rules-container">
      <!-- Conclusion Rules -->
      <div class="rule-section" *ngIf="filteredConclusionRules.length">
        <div class="section-title">{{ t.conclusionRules }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredConclusionRules" 
            type="button" 
            (click)="onProofRuleClick(rule)"
            class="rule-btn"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>

      <!-- Assumption Rules -->
      <div class="rule-section" *ngIf="filteredAssumptionRules.length">
        <div class="section-title">{{ t.assumptionRules }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredAssumptionRules" 
            type="button" 
            (click)="onProofRuleClick(rule)"
            class="rule-btn"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>

      <!-- Special Rules -->
      <div class="rule-section" *ngIf="filteredSpecialRules.length">
        <div class="section-title">{{ t.specialRules }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredSpecialRules" 
            type="button" 
            (click)="onProofRuleClick(rule)"
            class="rule-btn special"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>
    </div>

    <!-- Lambda to Expression Mode -->
    <div *ngIf="conversionMode === 'lambda-to-expression'" class="rules-container">
      <div class="rule-section" *ngIf="filteredBasicRules.length">
        <div class="section-title">{{ t.basicRules }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredBasicRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredAbsRules.length || filteredAppRules.length">
        <div class="section-title">{{ t.functions }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredAbsRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
          <button 
            *ngFor="let rule of filteredAppRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredPairRules.length || filteredSumRules.length">
        <div class="section-title">{{ t.pairsAndSums }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredPairRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
          <button 
            *ngFor="let rule of filteredSumRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredDependentRules.length">
        <div class="section-title">{{ t.dependentTypes }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredDependentRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredConditionalRules.length || filteredLetRules.length">
        <div class="section-title">{{ t.controlFlow }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredConditionalRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
          <button 
            *ngFor="let rule of filteredLetRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredNatRules.length">
        <div class="section-title">{{ t.naturals }}</div>
        <div class="rule-buttons">
          <button 
            *ngFor="let rule of filteredNatRules" 
            type="button" 
            (click)="onTypeRuleClick(rule)"
            class="rule-btn"
          >
            {{ rule }}
          </button>
        </div>
      </div>
    </div>

    <!-- Natural Deduction Mode -->
    <div *ngIf="conversionMode === 'natural-deduction'" class="rules-container">
      <div class="rule-section" *ngIf="filteredNdIntroRules.length">
        <div class="section-title">{{ t.introRules }}</div>
        <div class="rule-buttons">
          <button
            *ngFor="let rule of filteredNdIntroRules"
            type="button"
            (click)="onProofRuleClick(rule)"
            class="rule-btn"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredNdElimRules.length">
        <div class="section-title">{{ t.eliminationRules }}</div>
        <div class="rule-buttons">
          <button
            *ngFor="let rule of filteredNdElimRules"
            type="button"
            (click)="onProofRuleClick(rule)"
            class="rule-btn"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>

      <div class="rule-section" *ngIf="filteredNdQuantifierRules.length">
        <div class="section-title">{{ t.quantifierRules }}</div>
        <div class="rule-buttons">
          <button
            *ngFor="let rule of filteredNdQuantifierRules"
            type="button"
            (click)="onProofRuleClick(rule)"
            class="rule-btn"
          >
            {{ displayProofRule(rule) }}
          </button>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
